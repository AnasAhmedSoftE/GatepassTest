// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  SUB_ADMIN
}

enum RequestType {
  VISITOR
  CONTRACTOR
  EMPLOYEE
  VEHICLE
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ActionType {
  REQUEST_MANAGEMENT
  USER_MANAGEMENT
  SYSTEM_INTEGRATION
  AUTH
}

model User {
  id            Int      @id @default(autoincrement())
  name          String
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          UserRole @default(SUB_ADMIN)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  permissions        UserPermission[]
  createdRequests    Request[]        @relation("CreatedBy")
  approvedRequests   Request[]        @relation("ApprovedBy")
  activityLogs       ActivityLog[]

  @@map("users")
}

model Permission {
  id          Int    @id @default(autoincrement())
  key         String @unique
  description String

  // Relations
  users UserPermission[]

  @@map("permissions")
}

model UserPermission {
  id           Int @id @default(autoincrement())
  userId       Int @map("user_id")
  permissionId Int @map("permission_id")

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@map("user_permissions")
}

model Request {
  id                         Int           @id @default(autoincrement())
  requestNumber              String        @unique @map("request_number")
  applicantName              String        @map("applicant_name")
  applicantEmail             String        @map("applicant_email")
  passportIdNumber           String        @map("passport_id_number")
  passportIdImagePath        String?       @map("passport_id_image_path")
  purposeOfVisit             String        @db.Text @map("purpose_of_visit")
  dateOfVisit                DateTime      @map("date_of_visit")
  requestType                RequestType   @map("request_type")
  status                     RequestStatus @default(PENDING)
  rejectionReason            String?       @db.Text @map("rejection_reason")
  createdAt                  DateTime      @default(now()) @map("created_at")
  updatedAt                  DateTime      @updatedAt @map("updated_at")
  createdById                Int?          @map("created_by")
  approvedById               Int?          @map("approved_by")
  externalReference          String?       @map("external_reference")
  lastIntegrationStatusCode  Int?          @map("last_integration_status_code")
  lastIntegrationStatusMessage String?     @db.Text @map("last_integration_status_message")
  extraFields                Json?         @map("extra_fields")

  // Relations
  createdBy  User?         @relation("CreatedBy", fields: [createdById], references: [id])
  approvedBy User?         @relation("ApprovedBy", fields: [approvedById], references: [id])
  uploads    Upload[]

  @@index([status])
  @@index([requestType])
  @@index([dateOfVisit])
  @@index([createdAt])
  @@map("requests")
}

model Upload {
  id         Int      @id @default(autoincrement())
  requestId  Int      @map("request_id")
  fileType   String   @map("file_type")
  filePath   String   @map("file_path")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  // Relations
  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@map("uploads")
}

model ActivityLog {
  id                  Int         @id @default(autoincrement())
  timestamp           DateTime    @default(now())
  userId              Int?        @map("user_id")
  actionType          ActionType  @map("action_type")
  actionPerformed     String      @map("action_performed")
  affectedEntityType  String?     @map("affected_entity_type")
  affectedEntityId    Int?        @map("affected_entity_id")
  details             Json?

  // Relations
  user    User?    @relation(fields: [userId], references: [id])

  @@index([timestamp])
  @@index([actionType])
  @@index([userId])
  @@map("activity_logs")
}
