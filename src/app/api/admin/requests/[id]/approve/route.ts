import { NextRequest, NextResponse } from 'next/server';
import { requirePermission } from '@/middleware/api';
import prisma from '@/lib/prisma';
import { SoharPortClient } from '@/lib/sohar-port';
import { sendRequestApprovalEmail } from '@/lib/email';
import { ActionType } from '@prisma/client';
import { formatDate } from '@/utils/helpers';

export async function POST(
    request: NextRequest,
    { params }: { params: Promise<{ id: string }> }
) {
    const { id } = await params;
    return requirePermission(request, 'MANAGE_REQUESTS', async (req, user) => {
        try {
            const requestId = parseInt(id);

            if (isNaN(requestId)) {
                return NextResponse.json(
                    { error: 'Invalid Request', message: 'Invalid request ID' },
                    { status: 400 }
                );
            }

            const body = await req.json();

            // Get the request
            const gateRequest = await prisma.request.findUnique({
                where: { id: requestId },
            });

            if (!gateRequest) {
                return NextResponse.json(
                    { error: 'Not Found', message: 'Request not found' },
                    { status: 404 }
                );
            }

            if (gateRequest.status !== 'PENDING') {
                return NextResponse.json(
                    { error: 'Invalid Operation', message: 'Only pending requests can be approved' },
                    { status: 400 }
                );
            }

            // Apply any last-minute edits if provided
            if (body.updates) {
                const updateData: any = {};
                if (body.updates.applicantName) updateData.applicantName = body.updates.applicantName.trim();
                if (body.updates.applicantEmail) updateData.applicantEmail = body.updates.applicantEmail.toLowerCase().trim();
                if (body.updates.passportIdNumber) updateData.passportIdNumber = body.updates.passportIdNumber.toUpperCase().trim();
                if (body.updates.purposeOfVisit) updateData.purposeOfVisit = body.updates.purposeOfVisit.trim();
                if (body.updates.dateOfVisit) updateData.dateOfVisit = new Date(body.updates.dateOfVisit);
                if (body.updates.requestType) updateData.requestType = body.updates.requestType;
                if (body.updates.extraFields) updateData.extraFields = JSON.stringify(body.updates.extraFields);

                if (Object.keys(updateData).length > 0) {
                    await prisma.request.update({
                        where: { id: requestId },
                        data: updateData,
                    });

                    // Refresh the request data
                    const updatedRequest = await prisma.request.findUnique({
                        where: { id: requestId },
                    });
                    if (updatedRequest) {
                        Object.assign(gateRequest, updatedRequest);
                    }
                }
            }

            // Call Sohar Port API using new client architecture
            console.log(`Processing approval for request ${requestId}`);

            const soharPortClient = new SoharPortClient();
            console.log(`Sohar Port Client Mode: ${soharPortClient.isMockMode() ? 'MOCK' : 'REAL'}`);

            const apiResponse = await soharPortClient.send.createGatePass({
                requestNumber: gateRequest.requestNumber,
                applicantName: gateRequest.applicantName,
                applicantEmail: gateRequest.applicantEmail,
                passportIdNumber: gateRequest.passportIdNumber,
                purposeOfVisit: gateRequest.purposeOfVisit,
                dateOfVisit: gateRequest.dateOfVisit.toISOString(),
                requestType: gateRequest.requestType as any,
                extraFields: gateRequest.extraFields ? JSON.parse(gateRequest.extraFields as string) : undefined,
            });

            if (!apiResponse.success) {
                console.error('Sohar Port Integration Failed:', apiResponse);
                // API call failed - don't approve the request
                return NextResponse.json(
                    {
                        error: 'Integration Error',
                        message: 'Failed to submit to Sohar Port system',
                        details: {
                            statusCode: apiResponse.statusCode,
                            apiMessage: apiResponse.message,
                            apiError: apiResponse.error,
                        },
                    },
                    { status: 500 }
                );
            }

            // API call successful - approve the request
            const approvedRequest = await prisma.request.update({
                where: { id: requestId },
                data: {
                    status: 'APPROVED',
                    approvedById: user.userId,
                    externalReference: apiResponse.externalReference,
                    lastIntegrationStatusCode: apiResponse.statusCode,
                    lastIntegrationStatusMessage: apiResponse.message,
                },
            });

            // Log the approval
            await prisma.activityLog.create({
                data: {
                    userId: user.userId,
                    actionType: ActionType.REQUEST_MANAGEMENT,
                    actionPerformed: `Approved request ${gateRequest.requestNumber}`,
                    affectedEntityType: 'REQUEST',
                    affectedEntityId: requestId,
                    details: JSON.stringify({
                        approvedBy: user.email,
                        externalReference: apiResponse.externalReference,
                        statusCode: apiResponse.statusCode,
                    }),
                },
            });

            // Send approval email to applicant (async)
            sendRequestApprovalEmail(
                gateRequest.applicantEmail,
                gateRequest.applicantName,
                gateRequest.requestNumber,
                formatDate(gateRequest.dateOfVisit)
            ).catch(err => console.error('Failed to send approval email:', err));

            return NextResponse.json({
                success: true,
                message: 'Request approved successfully',
                data: {
                    request: approvedRequest,
                    integration: {
                        externalReference: apiResponse.externalReference,
                        statusCode: apiResponse.statusCode,
                        message: apiResponse.message,
                        qrCodePdfUrl: apiResponse.qrCodePdfUrl,
                    },
                },
            });

        } catch (error: any) {
            console.error('Error approving request:', error);
            return NextResponse.json(
                { error: 'Internal Server Error', message: 'Failed to approve request' },
                { status: 500 }
            );
        }
    });
}
